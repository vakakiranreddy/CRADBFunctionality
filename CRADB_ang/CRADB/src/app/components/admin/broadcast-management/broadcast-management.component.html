<app-sidebar></app-sidebar>

<div class="main-content" style="margin-left: 200px; padding: 30px; background: #f8f9fa; min-height: 100vh;">
  <div class="container-fluid">


<!-- Search and Filter Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div class="d-flex gap-3 align-items-center">
<!-- Search -->
        <div class="position-relative">
          <input type="text" class="form-control" placeholder="Search notifications..." 
                 (input)="onSearch($event)"
                 style="padding-left: 35px; border-radius: 8px; border: 1px solid #e0e0e0; width: 250px;">
          <i class="fas fa-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #999;"></i>
        </div>
        
        <!-- Filter by Location -->
        <select class="form-select" (change)="onLocationFilter($event)" 
                style="border-radius: 8px; border: 1px solid #e0e0e0; width: 160px; padding: 8px 12px; font-size: 14px; height: 40px;">
          <option value="">All Locations</option>
          @for (location of locations; track location.LocationId) {
            <option [value]="location.LocationId">{{ location.Name }}</option>
          }
        </select>
        
        <!-- Filter by Department -->
        <select class="form-select" (change)="onDepartmentFilter($event)"
                style="border-radius: 8px; border: 1px solid #e0e0e0; width: 170px; padding: 8px 12px; font-size: 14px; height: 40px;">
          <option value="">All Departments</option>
          @for (department of departments; track department.DepartmentId) {
            <option [value]="department.DepartmentId">{{ department.DepartmentName }}</option>
          }
        </select>
      </div>
      
      <button class="btn btn-primary" (click)="toggleForm()" style="border-radius: 8px; padding: 8px 20px; font-weight: 500;">
        Push Notification
      </button>
    </div>

    <!-- Notification List -->
    @if (loading) {
      <div class="text-center py-5">
        <div class="spinner-border" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading notifications...</p>
      </div>
} @else if (filteredBroadcasts.length === 0) {
      <div class="text-center py-5">
        <i class="fas fa-bell-slash fa-3x text-muted mb-3"></i>
        <h5>No Notifications Found</h5>
        <p class="text-muted">No broadcast notifications have been sent yet.</p>
      </div>
    } @else {
      <!-- Notification Cards -->
@for (broadcast of filteredBroadcasts; track broadcast.Id) {
        <div class="card mb-3" style="border: 1px solid #e0e0e0; border-radius: 12px;">
          <div class="card-body p-4">
            <h5 class="mb-2" style="font-weight: 600; font-size: 16px;">{{ broadcast.Title }}</h5>
            <p class="text-muted mb-3" style="font-size: 14px; line-height: 1.6;">
              {{ broadcast.Message }}
            </p>
            <div class="d-flex align-items-center gap-3 text-muted" style="font-size: 13px;">
              <div class="d-flex align-items-center gap-1">
                <i class="fas fa-map-marker-alt"></i>
                <span>{{ getTargetAudience(broadcast) }}</span>
              </div>
              <div class="d-flex align-items-center gap-1">
                <i class="fas fa-calendar"></i>
                <span>{{ formatDate(broadcast.SentAt) }}</span>
              </div>
              <div class="d-flex align-items-center gap-1">
                <i class="fas fa-clock"></i>
                <span>{{ formatTime(broadcast.SentAt) }}</span>
              </div>
            </div>
          </div>
        </div>
      }
    }
  </div>
</div>

<!-- Push Notification Modal -->
<div class="modal fade" id="notificationModal" tabindex="-1" [class.show]="showCreateForm" [style.display]="showCreateForm ? 'block' : 'none'">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content" style="border-radius: 16px; border: none;">
      <div class="modal-header" style="border-bottom: 1px solid #e0e0e0; padding: 20px 30px;">
        <h5 class="modal-title" style="font-weight: 600;">Post Notification</h5>
        <button type="button" class="btn-close" (click)="toggleForm()"></button>
      </div>
      <div class="modal-body" style="padding: 30px;">
        <form [formGroup]="broadcastForm" (ngSubmit)="saveBroadcast()">
          <!-- Notification Subject -->
          <div class="mb-4">
            <input type="text" class="form-control" formControlName="title" 
                   placeholder="Notification Subject" 
                   style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px 16px; font-size: 14px;">
          </div>

          <!-- Description -->
          <div class="mb-4">
            <textarea class="form-control" formControlName="message" rows="8" 
                      placeholder="Description"
                      style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px 16px; font-size: 14px; resize: none;"></textarea>
          </div>

          <!-- Target Type Dropdown -->
          <div class="mb-4">
            <select class="form-select" formControlName="targetType" (change)="onTargetTypeChange()"
                    style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px 16px; font-size: 14px; color: #666;">
              <option value="">Select Target Type</option>
              <option value="location">Location</option>
              <option value="department">Department</option>
              <option value="role">Role</option>
            </select>
          </div>

          <!-- Dynamic Target Selection -->
          @if (broadcastForm.get('targetType')?.value) {
            <div class="mb-4">
              <select class="form-select" formControlName="targetId"
                      style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px 16px; font-size: 14px; color: #666;">
                <option value="">Select {{ getTargetLabel() }}</option>
                @for (target of targetData; track target.id) {
                  <option [value]="target.id">{{ target.name }}</option>
                }
              </select>
            </div>
          }

          <!-- Action Buttons -->
          <div class="d-flex gap-2 justify-content-end">
            <button type="button" class="btn btn-outline-secondary" (click)="toggleForm()"
                    style="border-radius: 8px; padding: 10px 24px; font-weight: 500; border: 1px solid #e0e0e0;">
              Cancel
            </button>
            <button type="submit" class="btn btn-primary" [disabled]="broadcastForm.invalid || saving"
                    style="border-radius: 8px; padding: 10px 24px; font-weight: 500; background: #667eea; border: none;">
              {{ saving ? 'Sending...' : 'Send Notification' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal Backdrop -->
@if (showCreateForm) {
  <div class="modal-backdrop fade show" (click)="toggleForm()"></div>
}